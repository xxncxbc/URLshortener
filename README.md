# üìö API URL Shortener

## –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–ë–∞–∑–∞ URL API**: `http://localhost:8080`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: JWT Access Token and Refresh Token
- **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã**: net/http, gorm, bcrypt,
  golang-jwt/jwt/v5, joho/godotenv, DATA-DOG/go-sqlmock,
  go-playground/validator/v10

## üßë‚Äçüíª –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### POST `/auth/login`
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤.

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "JWT_ACCESS_TOKEN",
  "refresh_token": "JWT_REFRESH_TOKEN"
}
```

### POST `/auth/register`
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤.

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "name": "John Doe"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "JWT_ACCESS_TOKEN",
  "refresh_token": "JWT_REFRESH_TOKEN"
}
```

### POST `/auth/refresh`
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ refresh token.

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "refresh_token": "JWT_REFRESH_TOKEN"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "NEW_ACCESS_TOKEN",
  "refresh_token": "NEW_REFRESH_TOKEN"
}
```

## üîó –†–∞–±–æ—Ç–∞ —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å—Å—ã–ª–∫–∞–º–∏

### POST `/link`
–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π URL.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- Authorization: `{access_token}`

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "url": "https://example.com/very/long/url"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "ID": 10,
    "CreatedAt": "2025-03-17T00:50:50.5987413+03:00",
    "UpdatedAt": "2025-03-17T00:50:50.5987413+03:00",
    "DeletedAt": null,
    "url": "https://photomath.com",
    "hash": "xSxInejPNy",
    "user_id": 7
}
```
---

### GET `/{hash}`
–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–µ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL.

**–ü—Ä–∏–º–µ—Ä:**  
`GET /abc123`  
**–û—Ç–≤–µ—Ç:**  
`302 Redirect` –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL.

---

### GET `/link`
–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—Å—ã–ª–∫–∏

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- Authorization: `{access_token}`

- **–û—Ç–≤–µ—Ç:**
```json
{
    "ID": 10,
    "CreatedAt": "2025-03-17T00:50:50.5987413+03:00",
    "UpdatedAt": "2025-03-17T00:50:50.5987413+03:00",
    "DeletedAt": null,
    "url": "https://photomath.com",
    "hash": "xSxInejPNy",
    "user_id": 7
}
```

---

### DELETE `/link/{id}`
–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É –ø–æ ID.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- Authorization:`{access_token}`

**–û—Ç–≤–µ—Ç:**
- `204 No Content` –∏–ª–∏ –æ—à–∏–±–∫–∞ (403, 500)

---

### PATCH `/link/{id}`

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- Authorization:`{access_token}`

**–ó–∞–ø—Ä–æ—Å:**
```json
{
    "url": "https://google.com",
    "hash": "GGGGG"
}
```
**–û—Ç–≤–µ—Ç:**
```json
{
    "ID": 3,
    "CreatedAt": "2025-03-17T01:15:28.628897+03:00",
    "UpdatedAt": "2025-03-17T01:16:33.415534+03:00",
    "DeletedAt": null,
    "url": "https://google.com",
    "hash": "GGGGG",
    "user_id": 1
}
```
## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### GET `/stat?from=(YYYY-MM-DD/YYYY-MM)&to=(YYYY-MM-DD/YYYY-MM)&by=month`
–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —Å—Å—ã–ª–∫–∞–º, –≥–¥–µ sum —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ —Å—Å—ã–ª–∫–∞–º.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
- Authorization:`{access_token}`

**–û—Ç–≤–µ—Ç:**
```json
[
    {
        "period": "2025-03",
        "sum": 12
    }
]
```

---

### ‚öôÔ∏è Middleware –≤ –ø—Ä–æ–µ–∫—Ç–µ

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ middleware –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤. –û–Ω–∏ —É–ø—Ä–æ—â–∞—é—Ç –ª–æ–≥–∏–∫—É –∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–æ—Å—Å-—Å—Ä–µ–∑–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é) –¥–ª—è –≤—Å–µ—Ö –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ä–æ—É—Ç–æ–≤.

#### –û—Å–Ω–æ–≤–Ω—ã–µ middleware:

---

### 1Ô∏è‚É£ **Auth Middleware (`IsAuthed`)**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (email –∏ userId) –∏–∑ —Ç–æ–∫–µ–Ω–∞. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `401 Unauthorized`. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–∫–∏–¥—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞.

```go
func IsAuthed(next http.Handler, config *configs.Config) http.Handler
```

–î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
```go
email := r.Context().Value(middleware.ContextEmailKey).(string)
userId := r.Context().Value(middleware.ContextUserIdKey).(uint)
```

---

### 2Ô∏è‚É£ **CORS Middleware**

–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ CORS. –¢–∞–∫–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `OPTIONS` preflight-–∑–∞–ø—Ä–æ—Å—ã.

```go
func CORS(next http.Handler) http.Handler
```

–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
- `GET, POST, PUT, DELETE, HEAD, PATCH`

–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏:
- `authorization, content-type, content-length`

---

### 3Ô∏è‚É£ **Logging Middleware**

–õ–æ–≥–∏—Ä—É–µ—Ç:
- HTTP –º–µ—Ç–æ–¥
- –ü—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
- HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
```
200 GET /api/links 5.231ms
```

```go
func Logging(next http.Handler) http.Handler
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è ResponseWriter ‚Äî `WrapperWriter` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è HTTP —Å—Ç–∞—Ç—É—Å–∞.

---

### 4Ô∏è‚É£ **Chain Middleware**

–§—É–Ω–∫—Ü–∏—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö middleware –≤ –µ–¥–∏–Ω—É—é —Ü–µ–ø–æ—á–∫—É:

```go
stack := middleware.Chain(
	middleware.CORS,
	middleware.Logging,
)
```

–í—ã–∑–æ–≤ middleware –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —Ç.–µ. —Å–Ω–∞—á–∞–ª–∞ `Logging`, –∑–∞—Ç–µ–º `CORS`, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ handler.

---

### ‚úÖ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö middleware

```go
mux := http.NewServeMux()
mux.Handle("/api/protected", middleware.IsAuthed(yourHandler, config))

wrapped := middleware.Chain(
	middleware.CORS,
	middleware.Logging,
)(mux)

http.ListenAndServe(":8080", wrapped)
```
---


### ‚öô –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –∫–ª–∏–∫–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —à–∏–Ω—ã —Å–æ–±—ã—Ç–∏–π

–í —Å–∏—Å—Ç–µ–º–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –∫–ª–∏–∫–æ–≤ —Å –ø–æ–º–æ—â—å—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ event bus:

- –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ —Å–µ—Ä–≤–∏—Å –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `link_visited` –≤ —à–∏–Ω—É —Å–æ–±—ã—Ç–∏–π.
- –í —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–ø–∏—Å–∞–Ω–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —à–∏–Ω—ã –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ HTTP-—Å–µ—Ä–≤–µ—Ä–∞.
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –æ—Ç–¥–∞–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–≤–µ—Ç, –∞ –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–∫–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–∞.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

- **EventBus** ‚Äì —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π —Å –º–µ—Ç–æ–¥–∞–º–∏ `Publish` –∏ `Subscribe`.
- **StatService** ‚Äì —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `StatRepository`.

–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å API –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç—Ä–∞—Ñ–∏–∫–∞.

--- 


### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã API:

#### End-to-End (E2E) —Ç–µ—Å—Ç—ã

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —Å–∫–≤–æ–∑–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–∞–±–æ—Ç—É API –≤–º–µ—Å—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.

–ü—Ä–∏–º–µ—Ä:

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ `/auth/login`.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É—á–∞—è —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º.

–§–∞–π–ª: `auth_test.go`

---

#### Unit-—Ç–µ—Å—Ç—ã

–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

–ü—Ä–∏–º–µ—Ä:

- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JWT-—Ç–æ–∫–µ–Ω–∞.

–§–∞–π–ª: `jwthelper/jwt_test.go`

---

#### Mock-—Ç–µ—Å—Ç—ã

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–∫-–æ–±—ä–µ–∫—Ç—ã –∏ `sqlmock` –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

–ü—Ä–∏–º–µ—Ä—ã:

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–¥–º–µ–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ mock.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –º–æ–∫-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º.

–§–∞–π–ª—ã:
- `auth/handler_test.go`
- `auth/service_test.go`

---
